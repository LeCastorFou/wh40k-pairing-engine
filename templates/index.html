<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>40K Pairing Simulator</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;500&display=swap');

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Roboto', sans-serif;
      background: radial-gradient(circle at top, #333 0, #050509 50%, #000 100%);
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .frame {
      max-width: 900px;
      padding: 2.5rem 3rem;
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(10,10,15,0.95), rgba(5,5,8,0.98));
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow:
        0 0 40px rgba(0, 0, 0, 0.9),
        0 0 60px rgba(255, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }

    .frame::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 10% 10%, rgba(255,0,0,0.12), transparent 55%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.06), transparent 55%);
      opacity: 0.8;
      pointer-events: none;
    }

    .frame-inner { position: relative; z-index: 1; }

    h1 {
      font-family: 'Cinzel', serif;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin: 0 0 0.75rem;
      font-size: 1.9rem;
    }

    .subtitle {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.25em;
      color: #c0392b;
      margin-bottom: 1.0rem;
    }

    .teamline{
      margin: -0.25rem 0 1.25rem;
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #bbb;
    }
    .teamline strong{ color:#e74c3c; font-weight:500; }

    .flavour {
      font-size: 0.98rem;
      line-height: 1.65;
      color: #dcdcdc;
      margin-bottom: 1.5rem;
    }

    .flavour strong { color: #e74c3c; font-weight: 500; }

    .divider {
      margin: 1.5rem 0;
      height: 1px;
      border: none;
      background: linear-gradient(to right, transparent, #444, transparent);
    }

    .actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .btn {
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      padding: 0.7rem 1.6rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      text-decoration: none;
      color: #f5f5f5;
      background: linear-gradient(135deg, #b71c1c, #6d0000);
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, border-color 0.2s;
      box-shadow: 0 0 18px rgba(255,0,0,0.25);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -40%;
      height: 100%;
      width: 40%;
      background: linear-gradient(120deg, rgba(255,255,255,0.3), transparent);
      transform: skewX(-25deg);
      opacity: 0;
      transition: 0.25s;
    }

    .btn:hover::before { left: 120%; opacity: 1; }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 28px rgba(255,0,0,0.35);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .btn-secondary {
      background: transparent;
      box-shadow: none;
      border-color: rgba(255, 255, 255, 0.18);
      color: #ccc;
    }

    .meta { font-size: 0.8rem; color: #999; }

    /* ---- Locked state overlay on actions (keeps your design intact) ---- */
    .locked-wrap{
      position: relative;
    }
    .locked-overlay{
      position:absolute;
      inset:-0.35rem;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      display:none;
      align-items:center;
      justify-content: space-between;
      gap: 0.8rem;
      padding: 0.7rem 0.85rem;
      z-index: 5;
      backdrop-filter: blur(3px);
    }
    .locked-overlay .msg{
      font-size: 0.8rem;
      color:#ddd;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      opacity: 0.95;
    }

    /* ---- Modal ---- */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }
    .modal{
      width: min(520px, 96vw);
      background: rgba(10,10,15,0.98);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      box-shadow: 0 0 40px rgba(0,0,0,0.95);
      padding: 1.2rem 1.2rem 1rem;
      position: relative;
      overflow: hidden;
    }
    .modal::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 10% 10%, rgba(255,0,0,0.12), transparent 55%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.06), transparent 55%);
      opacity: 0.8;
      pointer-events:none;
    }
    .modal-inner{ position: relative; z-index: 1; }
    .modal h3{
      margin: 0 0 0.25rem;
      font-family:'Cinzel', serif;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .modal p{ margin: 0.35rem 0 0.95rem; color:#bbb; font-size: 0.9rem; line-height:1.5; }
    .row{ display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
    input[type="password"]{
      flex:1;
      background:#111;
      border:1px solid #444;
      border-radius:999px;
      padding:0.65rem 0.95rem;
      color:#f5f5f5;
      font-size: 0.95rem;
      outline:none;
      min-width: 220px;
    }
    input[type="password"]:focus{ border-color:#e74c3c; }
    .err{ color:#ff8a80; font-size:0.9rem; min-height:1.2em; margin-top:0.6rem; }
    .mini{
      font-size: 0.75rem;
      color: #999;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="frame-inner">
      <div class="subtitle">In the grim darkness of the far future...</div>
      <h1>Warhammer 40,000 Team Pairing Engine</h1>

      <!-- NEW: team name from env -->
      <div class="teamline">Bunker access: <strong>{{ team_name }}</strong></div>

      <p class="flavour">
        Forge your <strong>competitive pairings</strong> with ruthless precision.
        Track your players, their lists, and prepare for the pairing war before the first die is rolled.
      </p>

      <hr class="divider" />

      <div class="locked-wrap">
        <div class="actions" id="actions">
          <a href="{{ url_for('players_page') }}" class="btn">Manage Players &amp; Lists</a>
          <a href="{{ url_for('new_game_page') }}" class="btn btn-secondary">Create Game vs Opponent</a>
          <a href="{{ url_for('games_list_page') }}" class="btn btn-secondary">View Saved Games</a>
          <span class="btn btn-secondary" style="pointer-events:none; opacity:0.6;">More Coming Soon</span>
          <a href="{{ url_for('report_page') }}"
            class="btn btn-secondary"
            style="border-color:#66bb6a; color:#e0ffe0;">
            Players Action Report
          </a>
          <!-- NEW: logout appe ars only when logged in -->
          {% if logged_in %}
            <button class="btn btn-secondary" id="logout-btn">Logout</button>
          {% endif %}
        </div>

        <!-- NEW: overlay shown only when NOT logged in -->
        {% if not logged_in %}
        <div class="locked-overlay" id="locked-overlay">
          <div class="msg">Bunker sealed — authentication required.</div>
          <button class="btn" id="open-login-btn">Enter Bunker</button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Modal (only useful when locked, but harmless if shown) -->
  <div class="modal-backdrop" id="login-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="login-title">
      <div class="modal-inner">
        <div class="row" style="justify-content:space-between;">
          <h3 id="login-title">Access Protocol</h3>
          <button class="btn btn-secondary" id="close-login-btn" style="padding:0.55rem 1.1rem;">Close</button>
        </div>
        <p>
          Identify yourself to <strong style="color:#e74c3c; font-weight:500;">{{ team_name }}</strong>.
          Enter the bunker password.
        </p>

        <div class="row">
          <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" />
          <button class="btn" id="login-btn">Authenticate</button>
        </div>

        <div class="err" id="login-error"></div>
        <div class="mini">Tip: press Enter to confirm · Esc to close</div>
      </div>
    </div>
  </div>

  <script>
    const LOGGED_IN = {{ "true" if logged_in else "false" }};

    const backdrop = document.getElementById("login-backdrop");
    const overlay = document.getElementById("locked-overlay");
    const openBtn = document.getElementById("open-login-btn");
    const closeBtn = document.getElementById("close-login-btn");
    const loginBtn = document.getElementById("login-btn");
    const pwd = document.getElementById("login-password");
    const err = document.getElementById("login-error");

    function openModal() {
      if (!backdrop) return;
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
      if (err) err.textContent = "";
      if (pwd) pwd.value = "";
      setTimeout(() => pwd && pwd.focus(), 50);
    }
    function closeModal() {
      if (!backdrop) return;
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
    }

    async function doLogin() {
      if (!err) return;
      err.textContent = "";
      const password = (pwd.value || "").trim();
      if (!password) { err.textContent = "Password required."; return; }

      const res = await fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ password })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        err.textContent = data.error || "Login failed.";
        return;
      }
      window.location.reload();
    }

    // show overlay if locked
    if (!LOGGED_IN && overlay) {
      overlay.style.display = "flex";
      // prevent clicking links behind (overlay covers it anyway)
    }

    if (!LOGGED_IN && openBtn) {
      openBtn.addEventListener("click", openModal);
      document.addEventListener("keydown", (e) => { if (e.key === "Enter" && backdrop.style.display === "flex") doLogin(); });
    }

    if (closeBtn) closeBtn.addEventListener("click", closeModal);
    if (backdrop) backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });
    if (pwd) pwd.addEventListener("keydown", (e) => { if (e.key === "Enter") doLogin(); });
    if (loginBtn) loginBtn.addEventListener("click", doLogin);

    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await fetch("/api/logout", { method: "POST" });
        window.location.reload();
      });
    }

    // Optional: open modal immediately when locked (comment out if you don't want that)
    if (!LOGGED_IN) {
      // openModal();
    }
  </script>
</body>
</html>
